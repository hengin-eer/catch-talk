# #39-40 マイク入力状態の可視化と沈黙ロジックの修正

## 概要
マイク入力状態の可視化、沈黙検知ロジックの修正、および入力レベルと閾値を表示するUIの実装を行う。
これにより、ユーザーは自分の声がシステムに認識されているか、どの程度の音量で入力されているかを直感的に理解できるようになる。

## 仕様詳細

### 1. マイク入力状態の管理と可視化
- **要件**: マイク入力が正常に取得できているかどうかの状態を管理し、UIで表示する。
- **技術仕様**:
  - `ConversationCoordinator` および `useAudioProcessing` を拡張し、リアルタイムの音声入力状態（VAD判定結果や入力有無）を上位コンポーネントに通知できるようにする。
  - **変更点**: `volume` と `isSpeaking` は単一の値ではなく、**プレイヤーごと (`player1`, `player2`) のオブジェクト**として管理する。
- **UI仕様**:
  - **デバッグ用ランプUI**:
    - 入力あり（`isSpeaking` = true）: 点灯（例: 緑色 #4ade80）
    - 入力なし: 消灯（例: グレー #9ca3af）
    - 配置: 後述の入力レベルメーターの隣に配置。
    - **変更点**: Player 1, Player 2 それぞれに表示する。

### 2. 沈黙検知ロジックの修正
- **現状の課題**: 現在は `onPacket()`（音声認識完了時）でタイマーを設定しているため、発話中や認識処理中に沈黙判定が走る可能性がある。また、パケットが来ない限りタイマーが更新されない。
- **修正方針**:
  - **判定基準**: 「2人の話者（ユーザーと相手）がどちらも発話していない状態」が一定時間続いた場合を沈黙とする。
  - **ロジック詳細**:
    1. **どちらかの話者**が発話を開始 (`player1.isSpeaking || player2.isSpeaking`) したら、沈黙タイマーをリセットし、沈黙状態 (`isSilent`) を `false` にする。
    2. **両方の話者**が発話を終了 (`!p1.isSpeaking && !p2.isSpeaking`) した時点からタイマーをカウント開始する。
    3. 定数秒（例: 5000ms）経過しても新たな発話がなければ、沈黙状態 (`isSilent`) を `true` にする。
- **実装アプローチ**:
  - `useSilence` フックを修正し、パケット受信時刻 (`lastActivityTime`) だけでなく、リアルタイムの発話状態 (`isAnySpeaking`) を監視対象に加える。

### 3. 入力レベルと閾値のUI表示
- **要件**: マイク入力の音量と、VAD（音声区間検出）の閾値を視覚的に分かりやすく表示する。
- **UIデザイン要件**:
  - **形式**: インジケーター・プログレス・スライダー型（バー表示）。
  - **サイズ**: 幅 100px 程度。
  - **動作**:
    - 現在の入力音量（RMS値など）に応じてバーの長さが伸縮する。
    - VADの閾値（音声として認識するライン）をバー上に視覚的に示す（マーカーなど）。
  - **閾値超過時のフィードバック**:
    - 入力レベルが閾値を超えた場合、バーの背景色または色を変更してコントラストを強くする。
      - 例: 通常時は薄い青、閾値超えで濃い青または赤。
  - **配置**: デバッグ用ランプUIの隣に配置する。
  - **変更点**: Player 1, Player 2 それぞれに表示する。

## 実装ステップ

1.  **音声処理基盤の拡張**
    - `ConversationCoordinator` に `onRms`, `onVADStateChange` コールバックを追加し、現在の音量 (volume) と発話状態 (isSpeaking) を定期的に通知するように修正する。
    - `useAudioProcessing` フックでこのコールバックを受け取り、`volumes: { player1, player2 }`, `speakingStates: { player1, player2 }` として公開する。

2.  **沈黙ロジックの改修**
    - `useSilence` フックの引数を変更し、`isAnySpeaking` (boolean) フラグを受け取れるようにする。
    - `useEffect` 内のロジックを修正し、`!isAnySpeaking` の状態が継続した場合にのみタイマーが作動するようにする。

3.  **UIコンポーネントの実装**
    - `AudioInputIndicator` コンポーネントを作成。
      - Props: `label`, `volume` (0-1), `isSpeaking` (boolean), `threshold` (0-1)
      - CSS Modules でスタイリング。
    - `ChatAnalysisDebug` に組み込み、2人分のインジケーターを表示する。

4.  **統合と確認**
    - マイクに向かって話した時にバーが動き、閾値を超えると色が変わり、ランプが点灯することを確認。
    - 話し止めてから5秒後に沈黙判定（ログ出力や既存のデバッグ表示で確認）が行われることを確認。
